<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Escolar Seguro</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .user-info {
            margin-left: 20px;
            padding: 8px 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 20px;
            font-size: 14px;
        }
        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        .card-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .card {
            flex: 1;
            min-width: 200px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        .card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 25px;
            margin-top: 15px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .alert-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ« Sistema Escolar Seguro</h1>
            <nav>
                <ul style="display: flex; align-items: center; flex-wrap: wrap; list-style: none;">
                    <li><a href="index.html" class="active">Inicio</a></li>
                    <li><a href="#" id="btnRegistro">ğŸ“ Registrar Estudiante</a></li>
                    <li><a href="#" id="btnLista">ğŸ“‹ Lista de Estudiantes</a></li>
                    <li><a href="#" id="btnAPI">ğŸ”Œ API Externa</a></li>
                    <li><a href="pages/login.html" id="btnLogin">ğŸ” Iniciar SesiÃ³n</a></li>
                    <li><a href="pages/register.html" id="btnRegister">ğŸ“ Registrarse</a></li>
                    <li><a href="#" id="btnLogout" style="display:none;">ğŸšª Cerrar SesiÃ³n</a></li>
                    <li><span id="userInfo" class="user-info" style="display:none;"></span></li>
                </ul>
            </nav>
        </header>
        
        <main>
            <!-- Mensaje para usuarios no autenticados -->
            <div id="noAuthMessage" class="warning-message" style="display: none;">
                <strong>ğŸ”’ Acceso restringido</strong>
                <p>Para acceder a las funciones del sistema (Registrar estudiantes, Lista de estudiantes, API Externa), 
                por favor <a href="pages/login.html" style="color: #856404; font-weight: bold;">inicia sesiÃ³n</a> o 
                <a href="pages/register.html" style="color: #856404; font-weight: bold;">regÃ­strate</a>.</p>
            </div>

            <!-- Contenido para usuarios autenticados -->
            <div id="authContent" style="display: none;">
                <section class="welcome">
                    <h2>ğŸ‰ Â¡Bienvenido al Sistema Escolar!</h2>
                    <p>Selecciona una opciÃ³n del menÃº para comenzar:</p>
                    
                    <div class="card-container">
                        <div class="card">
                            <h3>ğŸ“ Registrar Estudiante</h3>
                            <p>Agrega nuevos estudiantes al sistema</p>
                            <a href="pages/registro.html" class="btn">Ir a Registro</a>
                        </div>
                        <div class="card">
                            <h3>ğŸ“‹ Lista de Estudiantes</h3>
                            <p>Ver, editar y gestionar estudiantes</p>
                            <a href="pages/estudiantes.html" class="btn">Ir a Lista</a>
                        </div>
                        <div class="card">
                            <h3>ğŸ”Œ API Externa</h3>
                            <p>Consultar estadÃ­sticas y datos</p>
                            <a href="pages/api-externa.html" class="btn">Ir a API</a>
                        </div>
                    </div>
                </section>
            </div>

            <!-- EstadÃ­sticas -->
            <section class="stats" style="margin-top: 40px; background: white; padding: 20px; border-radius: 10px;">
                <h3>ğŸ“Š EstadÃ­sticas del Sistema</h3>
                <div id="estadisticas" style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 10px;">
                    Cargando...
                </div>
            </section>
        </main>
    </div>
    
    <script>
        // FunciÃ³n para mostrar alerta personalizada
        function mostrarAlerta(mensaje, tipo = 'warning') {
            const alerta = document.createElement('div');
            alerta.className = 'alert-popup';
            
            if (tipo === 'warning') {
                alerta.style.background = '#ffc107';
                alerta.style.color = '#856404';
                alerta.style.borderLeft = '4px solid #856404';
            } else if (tipo === 'success') {
                alerta.style.background = '#28a745';
                alerta.style.color = 'white';
                alerta.style.borderLeft = '4px solid #1e7e34';
            }
            
            alerta.innerHTML = mensaje;
            document.body.appendChild(alerta);
            
            setTimeout(() => {
                alerta.remove();
            }, 3000);
        }

        // Verificar sesiÃ³n al cargar la pÃ¡gina
        async function verificarSesion() {
            try {
                const response = await fetch('/api/me', { 
                    method: 'GET',
                    credentials: 'include' 
                });
                
                if (response.ok) {
                    // Usuario AUTENTICADO
                    const usuario = await response.json();
                    
                    document.getElementById('authContent').style.display = 'block';
                    document.getElementById('noAuthMessage').style.display = 'none';
                    
                    document.getElementById('btnLogin').style.display = 'none';
                    document.getElementById('btnRegister').style.display = 'none';
                    document.getElementById('btnLogout').style.display = 'inline-block';
                    
                    const userSpan = document.getElementById('userInfo');
                    userSpan.style.display = 'inline-block';
                    userSpan.innerHTML = `ğŸ‘¤ ${usuario.username} ${usuario.isAdmin ? 'ğŸ‘‘' : ''}`;
                    
                    // Configurar enlaces DIRECTOS
                    document.getElementById('btnRegistro').onclick = (e) => {
                        e.preventDefault();
                        window.location.href = 'pages/registro.html';
                    };
                    
                    document.getElementById('btnLista').onclick = (e) => {
                        e.preventDefault();
                        window.location.href = 'pages/estudiantes.html';
                    };
                    
                    document.getElementById('btnAPI').onclick = (e) => {
                        e.preventDefault();
                        window.location.href = 'pages/api-externa.html';
                    };
                    
                    console.log('âœ… Usuario autenticado:', usuario.username);
                    
                } else {
                    // Usuario NO AUTENTICADO
                    mostrarVistaNoAutenticado();
                }
            } catch (error) {
                console.error('Error verificando sesiÃ³n:', error);
                mostrarVistaNoAutenticado();
            }
            
            // Siempre cargar estadÃ­sticas
            cargarEstadisticas();
        }

        function mostrarVistaNoAutenticado() {
            document.getElementById('noAuthMessage').style.display = 'block';
            document.getElementById('authContent').style.display = 'none';
            
            document.getElementById('btnLogin').style.display = 'inline-block';
            document.getElementById('btnRegister').style.display = 'inline-block';
            document.getElementById('btnLogout').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            
            // Configurar enlaces con redirecciÃ³n a login
            document.getElementById('btnRegistro').onclick = (e) => {
                e.preventDefault();
                mostrarAlerta('ğŸ”’ Debes iniciar sesiÃ³n para acceder a esta funciÃ³n', 'warning');
                setTimeout(() => {
                    window.location.href = 'pages/login.html';
                }, 2000);
            };
            
            document.getElementById('btnLista').onclick = (e) => {
                e.preventDefault();
                mostrarAlerta('ğŸ”’ Debes iniciar sesiÃ³n para acceder a esta funciÃ³n', 'warning');
                setTimeout(() => {
                    window.location.href = 'pages/login.html';
                }, 2000);
            };
            
            document.getElementById('btnAPI').onclick = (e) => {
                e.preventDefault();
                mostrarAlerta('ğŸ”’ Debes iniciar sesiÃ³n para acceder a esta funciÃ³n', 'warning');
                setTimeout(() => {
                    window.location.href = 'pages/login.html';
                }, 2000);
            };
        }

        // Cargar estadÃ­sticas
        function cargarEstadisticas() {
            const statsDiv = document.getElementById('estadisticas');
            
            fetch('/api/estudiantes', { 
                credentials: 'include' 
            })
            .then(response => {
                if (response.status === 401) {
                    statsDiv.innerHTML = `
                        <p style="color: #856404; text-align: center;">
                            ğŸ”’ <a href="pages/login.html" style="color: #856404; font-weight: bold;">Inicia sesiÃ³n</a> para ver las estadÃ­sticas completas
                        </p>
                    `;
                    return null;
                }
                return response.json();
            })
            .then(estudiantes => {
                if (estudiantes) {
                    statsDiv.innerHTML = `
                        <p><strong>Total de estudiantes registrados:</strong> ${estudiantes.length}</p>
                        <p><strong>Ãšltima actualizaciÃ³n:</strong> ${new Date().toLocaleString()}</p>
                    `;
                }
            })
            .catch(() => {
                statsDiv.innerHTML = `
                    <p style="color: #856404; text-align: center;">
                        ğŸ”’ <a href="pages/login.html" style="color: #856404; font-weight: bold;">Inicia sesiÃ³n</a> para ver estadÃ­sticas
                    </p>
                `;
            });
        }

        // Cerrar sesiÃ³n
        document.getElementById('btnLogout').onclick = async (e) => {
            e.preventDefault();
            
            try {
                const response = await fetch('/api/logout', { 
                    method: 'POST',
                    credentials: 'include' 
                });
                
                if (response.ok) {
                    mostrarAlerta('âœ… SesiÃ³n cerrada exitosamente', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            } catch (error) {
                console.error('Error al cerrar sesiÃ³n:', error);
                window.location.reload();
            }
        };

        // Inicializar
        document.addEventListener('DOMContentLoaded', verificarSesion);
    </script>
</body>
</html>